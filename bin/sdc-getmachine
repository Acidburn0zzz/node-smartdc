#!/usr/bin/env node
// -*- mode: js -*-
// Copyright 2011 Joyent, Inc.  All rights reserved.

var path = require('path');
var url = require('url');

var common = require('../lib/cli_common');



///--- Globals

var Options = {
  "account": String,
  "credentials": Boolean,
  "debug": Boolean,
  "help": Boolean,
  "identity": path,
  "keyId": String,
  "url": url
};

var ShortOptions = {
  "a": ["--account"],
  "c": ["--credentials"],
  "d": ["--debug"],
  "h": ["--help"],
  "?": ["--help"],
  "i": ["--identity"],
  "k": ["--keyId"],
  "u": ["--url"]
};

var usageStr = common.buildUsageString(Options) + ' machine(id)';



///--- Mainline

common.parseArguments(Options, ShortOptions, function(parsed) {
  if (parsed.argv.remain.length < 1)
    common.usage(usageStr, 1, 'machine(id) required');

  var client = common.newClient(parsed);

  function callback(err, obj, headers) {
    if (err) {
      console.error(err.message);
      process.exit(3);
    }

    if (obj)
      console.log(JSON.stringify(obj, null, 2));

    if (headers && headers['x-credentials-suppressed'])
      console.error('credentials were suppressed from metadata');
  }

  parsed.argv.remain.forEach(function(machine) {
    client.getMachine(machine, parsed.credentials || false, callback);
  });
}, usageStr);
